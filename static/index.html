<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="referrer" content="no-referrer" />
  <meta http-equiv="X-Content-Type-Options" content="nosniff" />
  <meta http-equiv="Content-Security-Policy" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title id="t">Interstellar Proxy</title>
  <link rel="stylesheet" href="assets/css/main.css">
    <link rel="manifest" href="manifest.json">
</head>

<body>
  <div class="proxy-container">
    <div class="url-bar">
      <div class="nav-buttons">
        <button class="nav-btn" id="back-btn" onclick="goBack()" disabled>←</button>
        <button class="nav-btn" id="forward-btn" onclick="goForward()" disabled>→</button>
        <button class="nav-btn" id="refresh-btn" onclick="refresh()">⟲</button>
        <button class="nav-btn" id="ai-btn" onclick="openAIWithScreenshot()">AI質問</button>
        <button class="nav-btn" id="multimodal-btn" onclick="openMultimodalLive()">🎥 マルチモーダルAI</button>
      </div>
      <input type="text" class="url-input" id="url-input" placeholder="URLまたは検索語句を入力..." value="https://google.com">
      <button class="go-btn" onclick="navigate()">移動</button>
    </div>
    
    <div class="error-message" id="error-message"></div>
    
    <div class="iframe-container">
      <div class="loading" id="loading">読み込み中...</div>
      <iframe class="proxy-iframe" id="proxy-iframe" sandbox="allow-same-origin allow-scripts allow-forms allow-popups allow-top-navigation-by-user-activation"></iframe>
    </div>
  </div>

  <script src="./assets/js/speech-recognition.js"></script>
  <script src="./assets/mathematics/bundle.js?v=2025-06-01"></script>
  <script src="./assets/mathematics/config.js?v=2025-06-01"></script>
  <script src="https://cdn.jsdelivr.net/npm/dom-to-image-more@3.6.0/dist/dom-to-image-more.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/dom-to-image-more@3.6.0/spec/resources/fonts/web-fonts/embedded.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/winbox@0.2.82/dist/winbox.bundle.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/winbox@0.2.82/dist/css/winbox.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/marked@15.0.12/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.5/dist/purify.min.js"></script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <script>
    // MathJax設定
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']],
        processEscapes: true,
        processEnvironments: true,
        autoload: {
          color: [],
          colorV2: ['color']
        },
        packages: {'[+]': ['noerrors']}
      },
      options: {
        skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
        ignoreHtmlClass: 'tex2jax_ignore',
        processHtmlClass: 'tex2jax_process'
      },
      loader: {
        load: ['[tex]/noerrors']
      },
      startup: {
        ready: () => {
          MathJax.startup.defaultReady();
          console.log('MathJax ready');
        }
      }
    };

    // Service Workerをiframeプロキシ用に登録
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js?v=2025-06-01', {
          scope: '/'
        }).then((registration) => {
          console.log('Service Worker registered for iframe proxy:', registration);
        }).catch((error) => {
          console.error('Service Worker registration failed:', error);
        });
      });
    }

    // Multimodal Live APIを開く関数
    function openMultimodalLive() {
        createMultimodalLiveChat();
    }

    // Multimodal Live Chat を WinBox で作成
    function createMultimodalLiveChat() {
        const winbox = new WinBox({
            title: "🎥 Multimodal Live AI",
            width: 600,
            height: 700,
            x: "center",
            y: "center",
            background: "linear-gradient(135deg, #667eea 0%, #764ba2 100%)"
        });

        // コンテナ作成
        const container = document.createElement('div');
        container.id = 'multimodal-live-container';
        Object.assign(container.style, {
            display: 'flex',
            flexDirection: 'column',
            height: '100%',
            fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
            background: 'linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%)',
            color: '#1a1a1a'
        });

        // ヘッダー
        const header = document.createElement('div');
        Object.assign(header.style, {
            padding: '15px 20px',
            background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
            color: 'white',
            textAlign: 'center',
            borderRadius: '0 0 15px 15px',
            marginBottom: '15px',
            boxShadow: '0 4px 15px rgba(0,0,0,0.1)'
        });
        header.innerHTML = `
            <h3 style="margin: 0 0 8px 0; font-size: 18px; font-weight: 600;">
                <i class="fas fa-video" style="margin-right: 8px;"></i>
                Multimodal Live AI
            </h3>
            <p style="margin: 0; opacity: 0.9; font-size: 12px;">
                画面共有とマイクでリアルタイムAI対話
            </p>
        `;

        // ビデオエリア
        const videoContainer = document.createElement('div');
        Object.assign(videoContainer.style, {
            position: 'relative',
            width: '100%',
            height: '200px',
            background: '#f8f9fa',
            borderRadius: '12px',
            margin: '0 15px 15px 15px',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            border: '2px dashed #dee2e6',
            overflow: 'hidden'
        });

        const video = document.createElement('video');
        video.id = 'multimodal-video';
        video.autoplay = true;
        video.muted = true;
        video.playsInline = true;
        Object.assign(video.style, {
            width: '100%',
            height: '100%',
            objectFit: 'cover',
            borderRadius: '12px',
            display: 'none'
        });

        const placeholder = document.createElement('div');
        placeholder.id = 'video-placeholder';
        placeholder.innerHTML = `
            <div style="text-align: center; color: #6c757d;">
                <div style="font-size: 2rem; margin-bottom: 8px;">🖥️</div>
                <div style="font-size: 14px;">画面共有を開始してください</div>
            </div>
        `;

        const recordingIndicator = document.createElement('div');
        recordingIndicator.id = 'recording-indicator';
        recordingIndicator.innerHTML = '<span>🔴</span> 録画中';
        Object.assign(recordingIndicator.style, {
            position: 'absolute',
            top: '10px',
            right: '10px',
            background: '#dc3545',
            color: 'white',
            padding: '4px 10px',
            borderRadius: '12px',
            fontSize: '11px',
            fontWeight: '600',
            display: 'none'
        });

        videoContainer.appendChild(video);
        videoContainer.appendChild(placeholder);
        videoContainer.appendChild(recordingIndicator);

        // コントロールボタン
        const controls = document.createElement('div');
        Object.assign(controls.style, {
            display: 'flex',
            gap: '10px',
            justifyContent: 'center',
            padding: '0 15px 15px 15px',
            flexWrap: 'wrap'
        });

        const createBtn = (text, icon, primary = false) => {
            const btn = document.createElement('button');
            btn.innerHTML = `<i class="${icon}"></i> ${text}`;
            Object.assign(btn.style, {
                padding: '8px 16px',
                border: 'none',
                borderRadius: '20px',
                cursor: 'pointer',
                fontSize: '12px',
                fontWeight: '500',
                transition: 'all 0.2s ease',
                background: primary ? '#667eea' : '#6c757d',
                color: 'white'
            });
            return btn;
        };

        const startCameraBtn = createBtn('画面共有', 'fas fa-desktop', true);
        const stopCameraBtn = createBtn('共有停止', 'fas fa-stop');
        const startSessionBtn = createBtn('セッション開始', 'fas fa-play', true);
        const stopSessionBtn = createBtn('セッション停止', 'fas fa-pause');

        stopCameraBtn.disabled = true;
        startSessionBtn.disabled = true;
        stopSessionBtn.disabled = true;

        controls.appendChild(startCameraBtn);
        controls.appendChild(stopCameraBtn);
        controls.appendChild(startSessionBtn);
        controls.appendChild(stopSessionBtn);

        // チャットエリア
        const chatContainer = document.createElement('div');
        Object.assign(chatContainer.style, {
            flex: '1',
            margin: '0 15px',
            background: 'white',
            borderRadius: '12px',
            display: 'flex',
            flexDirection: 'column',
            boxShadow: '0 2px 10px rgba(0,0,0,0.1)',
            overflow: 'hidden'
        });

        const chatMessages = document.createElement('div');
        chatMessages.id = 'multimodal-chat-messages';
        Object.assign(chatMessages.style, {
            flex: '1',
            padding: '15px',
            overflowY: 'auto',
            display: 'flex',
            flexDirection: 'column',
            gap: '10px',
            maxHeight: '200px'
        });

        const welcomeMsg = document.createElement('div');
        Object.assign(welcomeMsg.style, {
            background: '#f8f9fa',
            padding: '10px 12px',
            borderRadius: '12px',
            fontSize: '12px',
            color: '#6c757d',
            textAlign: 'center',
            border: '1px solid #e9ecef'
        });
        welcomeMsg.innerHTML = '<i class="fas fa-info-circle"></i> セッションを開始すると、リアルタイムAI対話が始まります';
        chatMessages.appendChild(welcomeMsg);

        // 入力エリア
        const inputArea = document.createElement('div');
        Object.assign(inputArea.style, {
            padding: '12px 15px',
            borderTop: '1px solid #e9ecef',
            background: '#f8f9fa'
        });

        const inputContainer = document.createElement('div');
        Object.assign(inputContainer.style, {
            display: 'flex',
            gap: '8px',
            alignItems: 'center'
        });

        const textInput = document.createElement('input');
        textInput.type = 'text';
        textInput.placeholder = 'テキストメッセージ...';
        textInput.disabled = true;
        Object.assign(textInput.style, {
            flex: '1',
            padding: '8px 12px',
            border: '1px solid #dee2e6',
            borderRadius: '15px',
            fontSize: '12px',
            outline: 'none'
        });

        const sendBtn = createBtn('送信', 'fas fa-paper-plane', true);
        sendBtn.disabled = true;

        inputContainer.appendChild(textInput);
        inputContainer.appendChild(sendBtn);
        inputArea.appendChild(inputContainer);

        chatContainer.appendChild(chatMessages);
        chatContainer.appendChild(inputArea);

        // ステータス表示
        const statusContainer = document.createElement('div');
        Object.assign(statusContainer.style, {
            display: 'flex',
            gap: '10px',
            justifyContent: 'center',
            padding: '10px 15px 15px 15px'
        });

        const createStatus = (label) => {
            const status = document.createElement('div');
            Object.assign(status.style, {
                display: 'flex',
                alignItems: 'center',
                gap: '6px',
                padding: '6px 12px',
                background: 'white',
                borderRadius: '15px',
                fontSize: '11px',
                fontWeight: '500',
                boxShadow: '0 1px 5px rgba(0,0,0,0.1)'
            });
            
            const dot = document.createElement('div');
            Object.assign(dot.style, {
                width: '8px',
                height: '8px',
                borderRadius: '50%',
                background: '#dc3545'
            });
            
            const text = document.createElement('span');
            text.textContent = label;
            
            status.appendChild(dot);
            status.appendChild(text);
            status.dot = dot;
            status.text = text;
            return status;
        };

        const connectionStatus = createStatus('未接続');
        const audioStatus = createStatus('音声待機');
        const videoStatus = createStatus('映像待機');

        statusContainer.appendChild(connectionStatus);
        statusContainer.appendChild(audioStatus);
        statusContainer.appendChild(videoStatus);

        // コンテナに追加
        container.appendChild(header);
        container.appendChild(videoContainer);
        container.appendChild(controls);
        container.appendChild(chatContainer);
        container.appendChild(statusContainer);

        winbox.body.appendChild(container);

        // Multimodal Live クライアント変数
        let multimodalClient = null;
        let mediaStream = null;
        let ws = null;
        let isSessionActive = false;

        // ステータス更新関数
        const updateStatus = (statusElement, state, text) => {
            const colors = {
                disconnected: '#dc3545',
                connecting: '#ffc107',
                connected: '#28a745',
                active: '#28a745',
                inactive: '#dc3545',
                error: '#dc3545'
            };
            statusElement.dot.style.background = colors[state] || '#dc3545';
            statusElement.text.textContent = text;
        };

        // 画面キャプチャ開始
        startCameraBtn.addEventListener('click', async () => {
            try {
                updateStatus(videoStatus, 'connecting', '接続中...');
                
                // 画面キャプチャとマイクの組み合わせ
                const displayStream = await navigator.mediaDevices.getDisplayMedia({
                    video: {
                        width: 1920,
                        height: 1080,
                        frameRate: 15
                    },
                    audio: false
                });
                
                const audioStream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        sampleRate: 16000,
                        channelCount: 1,
                        echoCancellation: true,
                        noiseSuppression: true
                    }
                });
                
                // 画面とマイク音声を組み合わせ
                mediaStream = new MediaStream([
                    ...displayStream.getVideoTracks(),
                    ...audioStream.getAudioTracks()
                ]);
                
                video.srcObject = displayStream;
                video.style.display = 'block';
                placeholder.style.display = 'none';
                
                updateStatus(videoStatus, 'active', '画面共有中');
                updateStatus(audioStatus, 'active', '音声有効');
                
                startCameraBtn.disabled = true;
                stopCameraBtn.disabled = false;
                startSessionBtn.disabled = false;
                
                // 画面共有が終了した時の処理
                displayStream.getVideoTracks()[0].addEventListener('ended', () => {
                    addMessage('system', '画面共有が終了しました');
                    if (mediaStream) {
                        mediaStream.getTracks().forEach(track => track.stop());
                        mediaStream = null;
                    }
                    video.style.display = 'none';
                    placeholder.style.display = 'block';
                    updateStatus(videoStatus, 'inactive', '映像待機');
                    updateStatus(audioStatus, 'inactive', '音声待機');
                    startCameraBtn.disabled = false;
                    stopCameraBtn.disabled = true;
                    startSessionBtn.disabled = true;
                    if (isSessionActive) {
                        stopSession();
                    }
                });
                
                addMessage('system', '画面共有とマイクが有効になりました');
                
            } catch (error) {
                console.error('画面キャプチャエラー:', error);
                updateStatus(videoStatus, 'error', 'キャプチャエラー');
                updateStatus(audioStatus, 'error', 'マイクエラー');
                addMessage('system', `エラー: ${error.message}`);
            }
        });

        // 画面共有停止
        stopCameraBtn.addEventListener('click', () => {
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
                mediaStream = null;
            }
            
            video.style.display = 'none';
            placeholder.style.display = 'block';
            recordingIndicator.style.display = 'none';
            
            updateStatus(videoStatus, 'inactive', '映像待機');
            updateStatus(audioStatus, 'inactive', '音声待機');
            
            startCameraBtn.disabled = false;
            stopCameraBtn.disabled = true;
            startSessionBtn.disabled = true;
            
            if (isSessionActive) {
                stopSession();
            }
            
            addMessage('system', '画面共有とマイクを停止しました');
        });

        // セッション開始
        startSessionBtn.addEventListener('click', async () => {
            try {
                updateStatus(connectionStatus, 'connecting', '接続中...');
                addMessage('system', 'AI接続中...');
                
                ws = new WebSocket(`ws://${window.location.host}/ws/multimodal-live`);
                
                ws.onopen = () => {
                    isSessionActive = true;
                    updateStatus(connectionStatus, 'connected', '接続済み');
                    addMessage('system', '✅ AIセッション開始！');
                    
                    startSessionBtn.disabled = true;
                    stopSessionBtn.disabled = false;
                    textInput.disabled = false;
                    sendBtn.disabled = false;
                    recordingIndicator.style.display = 'block';
                    
                    startStreaming();
                };
                
                ws.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    handleServerMessage(data);
                };
                
                ws.onclose = () => {
                    isSessionActive = false;
                    updateStatus(connectionStatus, 'disconnected', '未接続');
                    addMessage('system', '❌ セッション終了');
                    
                    startSessionBtn.disabled = false;
                    stopSessionBtn.disabled = true;
                    textInput.disabled = true;
                    sendBtn.disabled = true;
                    recordingIndicator.style.display = 'none';
                };
                
                ws.onerror = (error) => {
                    console.error('WebSocket error:', error);
                    updateStatus(connectionStatus, 'error', '接続エラー');
                    addMessage('system', '❌ 接続エラー');
                };
                
            } catch (error) {
                console.error('セッション開始エラー:', error);
                updateStatus(connectionStatus, 'error', '接続エラー');
                addMessage('system', `エラー: ${error.message}`);
            }
        });

        // セッション停止
        const stopSession = () => {
            if (ws) {
                ws.close();
                ws = null;
            }
            isSessionActive = false;
            recordingIndicator.style.display = 'none';
            addMessage('system', 'セッションを停止しました');
        };

        stopSessionBtn.addEventListener('click', stopSession);

        // メッセージ送信
        const sendMessage = () => {
            const text = textInput.value.trim();
            if (!text || !isSessionActive) return;
            
            ws.send(JSON.stringify({
                type: 'text',
                content: text,
                timestamp: Date.now()
            }));
            
            addMessage('user', text);
            textInput.value = '';
        };

        sendBtn.addEventListener('click', sendMessage);
        textInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        // メッセージ追加
        const addMessage = (type, content, isPartial = false) => {
            if (type === 'ai' && isPartial) {
                // 既存のAIメッセージを更新
                const lastMsg = chatMessages.lastElementChild;
                if (lastMsg && lastMsg.classList.contains('ai-message')) {
                    lastMsg.innerHTML = `
                        <div style="font-size: 11px; color: #6c757d; margin-bottom: 4px;">
                            <i class="fas fa-robot"></i> AI
                        </div>
                        ${renderMarkdown(content)}
                    `;
                    renderMathInElement(lastMsg);
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                    return;
                }
            }
            
            const msgDiv = document.createElement('div');
            msgDiv.className = `${type}-message`;
            
            const styles = {
                user: { background: '#667eea', color: 'white', alignSelf: 'flex-end' },
                ai: { background: '#f8f9fa', color: '#333', alignSelf: 'flex-start' },
                system: { background: '#fff3cd', color: '#856404', alignSelf: 'center', textAlign: 'center' }
            };
            
            Object.assign(msgDiv.style, {
                padding: '8px 12px',
                borderRadius: '12px',
                maxWidth: '85%',
                fontSize: '12px',
                lineHeight: '1.4',
                wordWrap: 'break-word',
                ...styles[type]
            });
            
            if (type === 'user') {
                msgDiv.innerHTML = `
                    <div style="font-size: 11px; opacity: 0.8; margin-bottom: 4px;">あなた</div>
                    ${content}
                `;
            } else if (type === 'ai') {
                msgDiv.innerHTML = `
                    <div style="font-size: 11px; color: #6c757d; margin-bottom: 4px;">
                        <i class="fas fa-robot"></i> AI
                    </div>
                    ${renderMarkdown(content)}
                `;
            } else {
                msgDiv.innerHTML = `<i class="fas fa-info-circle"></i> ${content}`;
            }
            
            chatMessages.appendChild(msgDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            if (type === 'ai') {
                renderMathInElement(msgDiv);
            }
        };

        // サーバーメッセージ処理
        const handleServerMessage = (data) => {
            switch (data.type) {
                case 'ai_response':
                    if (data.isPartial) {
                        addMessage('ai', data.content, true);
                    } else if (data.isComplete) {
                        // 完了処理
                    } else {
                        addMessage('ai', data.content);
                    }
                    break;
                case 'transcription':
                    addMessage('user', `🎤 ${data.content}`);
                    break;
                case 'system':
                    addMessage('system', data.content);
                    break;
                case 'error':
                    addMessage('system', `❌ ${data.content}`);
                    break;
            }
        };

        // ストリーミング開始
        let currentAIResponse = '';
        const startStreaming = () => {
            if (!mediaStream || !isSessionActive) return;
            
            // 音声ストリーミング（簡略化）
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const source = audioContext.createMediaStreamSource(mediaStream);
            const processor = audioContext.createScriptProcessor(4096, 1, 1);
            
            processor.onaudioprocess = (event) => {
                if (isSessionActive && ws.readyState === WebSocket.OPEN) {
                    const audioData = event.inputBuffer.getChannelData(0);
                    const int16Array = new Int16Array(audioData.length);
                    for (let i = 0; i < audioData.length; i++) {
                        int16Array[i] = audioData[i] * 0x7FFF;
                    }
                    
                    ws.send(JSON.stringify({
                        type: 'audio',
                        data: Array.from(int16Array),
                        timestamp: Date.now()
                    }));
                }
            };
            
            source.connect(processor);
            processor.connect(audioContext.destination);
            
            // 映像ストリーミング（定期送信）
            const sendVideoFrame = () => {
                if (!isSessionActive || !video.videoWidth) return;
                
                const canvas = document.createElement('canvas');
                canvas.width = 320;
                canvas.height = 240;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                canvas.toBlob((blob) => {
                    if (blob && isSessionActive && ws.readyState === WebSocket.OPEN) {
                        const reader = new FileReader();
                        reader.onload = () => {
                            const base64 = reader.result.split(',')[1];
                            ws.send(JSON.stringify({
                                type: 'video',
                                data: base64,
                                timestamp: Date.now()
                            }));
                        };
                        reader.readAsDataURL(blob);
                    }
                }, 'image/jpeg', 0.7);
                
                if (isSessionActive) {
                    setTimeout(sendVideoFrame, 2000); // 2秒間隔
                }
            };
            
            sendVideoFrame();
        };
    }

    // iOS検出関数
    function isIOS() {
        return /iPad|iPhone|iPod/.test(navigator.userAgent) ||
               (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
    }

    // iOS用のアラートメッセージを表示
    function showIOSCaptureAlert() {
        const alertDiv = document.createElement('div');
        Object.assign(alertDiv.style, {
            position: 'fixed',
            top: '50%',
            left: '50%',
            transform: 'translate(-50%, -50%)',
            background: 'white',
            borderRadius: '12px',
            padding: '24px',
            boxShadow: '0 10px 40px rgba(0,0,0,0.3)',
            zIndex: 10001,
            fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
            color: '#1a1a1a',
            maxWidth: '320px',
            textAlign: 'center'
        });

        alertDiv.innerHTML = `
            <h3 style="margin: 0 0 16px 0; font-size: 18px; color: #374151;"><i class="fas fa-mobile-alt"></i> iOS画面キャプチャ</h3>
            <p style="margin: 0 0 20px 0; font-size: 14px; color: #6b7280; line-height: 1.5;">
                iOSデバイスでは、以下の方法で画面をキャプチャしてください：<br><br>
                <strong>1. スクリーンショット撮影</strong><br>
                • iPhone X以降: サイドボタン + 音量上ボタン<br>
                • iPhone 8以前: ホームボタン + サイドボタン<br><br>
                <strong>2. 写真アプリから画像を選択</strong><br>
                <i class="fas fa-paperclip"></i>ボタンをタップして画像をアップロード
            </p>
            <button id="ios-alert-ok" style="
                background: #007AFF;
                color: white;
                border: none;
                padding: 12px 24px;
                border-radius: 8px;
                cursor: pointer;
                font-size: 16px;
                font-weight: 500;
            ">了解</button>
        `;

        document.body.appendChild(alertDiv);

        // ボタンイベント
        const okBtn = alertDiv.querySelector('#ios-alert-ok');
        okBtn.addEventListener('click', () => {
            alertDiv.remove();
        });

        // 5秒後に自動で閉じる
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 8000);
    }

    // WinBoxウインドウを一時的に非表示にする関数
    function hideAllWinBoxWindows() {
        const winboxElements = document.querySelectorAll('.winbox');
        const visibleWindows = [];
        
        winboxElements.forEach((element) => {
            if (element.style.display !== 'none') {
                visibleWindows.push(element);
                element.style.display = 'none';
            }
        });
        
        return visibleWindows;
    }

    // WinBoxウインドウを再表示する関数
    function showWinBoxWindows(windows) {
        windows.forEach((element) => {
            element.style.display = '';
        });
    }

    // Markdownをレンダリングする関数（LaTeX対応）
    function renderMarkdown(text) {
        if (typeof marked === 'undefined' || typeof DOMPurify === 'undefined') {
            return text;
        }
        
        try {
            marked.setOptions({
                breaks: true,
                gfm: true,
                headerIds: false,
                mangle: false
            });
            
            const html = marked.parse(text);
            
            const cleanHtml = DOMPurify.sanitize(html, {
                ALLOWED_TAGS: [
                    'p', 'br', 'strong', 'em', 'u', 'del', 's', 'mark',
                    'h1', 'h2', 'h3', 'h4', 'h5', 'h6',
                    'ul', 'ol', 'li',
                    'blockquote',
                    'code', 'pre',
                    'a', 'img',
                    'table', 'thead', 'tbody', 'tr', 'th', 'td',
                    'span', 'div', 'script'
                ],
                ALLOWED_ATTR: [
                    'href', 'src', 'alt', 'title', 'target', 'rel',
                    'class', 'id', 'data-*', 'type'
                ],
                ALLOWED_URI_REGEXP: /^(?:(?:(?:f|ht)tps?|mailto|tel|callto|cid|xmpp):|[^a-z]|[a-z+.\-]+(?:[^a-z+.\-:]|$))/i,
                ALLOW_DATA_ATTR: true
            });
            
            return cleanHtml;
        } catch (error) {
            console.error('Markdown rendering error:', error);
            return text;
        }
    }

    // MathJaxでLaTeX数式をレンダリングする関数
    function renderMathInElement(element) {
        if (typeof MathJax !== 'undefined' && MathJax.typesetPromise) {
            MathJax.typesetClear([element]);
            MathJax.typesetPromise([element]).then(() => {
                console.log('MathJax rendering completed');
            }).catch((err) => {
                console.error('MathJax rendering error:', err);
            });
        } else {
            setTimeout(() => {
                if (typeof MathJax !== 'undefined' && MathJax.typesetPromise) {
                    MathJax.typesetClear([element]);
                    MathJax.typesetPromise([element]).catch((err) => {
                        console.error('MathJax rendering error (retry):', err);
                    });
                }
            }, 500);
        }
    }

    // AI Chat functionality
    let chatHistory = [];
    
    function createAIChat() {
        const winbox = new WinBox({
            title: "AI Assistant",
            width: 380,
            height: 580,
            x: "right",
            y: "center"
        });

        // Create the chat UI dynamically
        const container = document.createElement('div');
        container.id = 'ai-chat-container';
        Object.assign(container.style, {
            display: 'flex',
            flexDirection: 'column',
            height: '100%',
            fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
            background: '#ffffff',
            color: '#1a1a1a'
        });

        // Chat Messages
        const chatMessages = document.createElement('div');
        chatMessages.id = 'chat-messages';
        Object.assign(chatMessages.style, {
            flex: '1',
            padding: '16px',
            overflowY: 'auto',
            display: 'flex',
            flexDirection: 'column',
            gap: '12px',
            background: '#f8fafc'
        });

        // 既存のチャット履歴を表示
        if (chatHistory.length === 0) {
            const welcomeMsg = document.createElement('div');
            Object.assign(welcomeMsg.style, {
                background: '#ffffff',
                padding: '12px 16px',
                borderRadius: '16px',
                boxShadow: '0 1px 3px rgba(0,0,0,0.1)',
                maxWidth: '85%',
                alignSelf: 'flex-start',
                border: '1px solid #e5e7eb',
                fontSize: '14px',
                lineHeight: '1.5'
            });
            welcomeMsg.textContent = 'わからない問題があれば聞いて下さい。画像もアップロードできます。';
            chatMessages.appendChild(welcomeMsg);
        } else {
            // 既存の履歴を表示
            chatHistory.forEach(item => {
                if (item.type === 'user') {
                    const userMsg = document.createElement('div');
                    Object.assign(userMsg.style, {
                        background: '#3b82f6',
                        color: 'white',
                        padding: '12px 16px',
                        borderRadius: '16px 16px 4px 16px',
                        maxWidth: '85%',
                        alignSelf: 'flex-end',
                        wordWrap: 'break-word',
                        fontSize: '14px',
                        lineHeight: '1.5',
                        boxShadow: '0 1px 3px rgba(0,0,0,0.1)'
                    });
                    
                    if (item.image) {
                        const imagePreview = document.createElement('img');
                        imagePreview.src = item.image;
                        Object.assign(imagePreview.style, {
                            maxWidth: '200px',
                            maxHeight: '200px',
                            borderRadius: '8px',
                            marginBottom: '8px',
                            display: 'block'
                        });
                        userMsg.appendChild(imagePreview);
                    }
                    
                    const textPart = document.createElement('div');
                    textPart.textContent = item.content;
                    userMsg.appendChild(textPart);
                    chatMessages.appendChild(userMsg);
                } else if (item.type === 'ai') {
                    const aiMsg = document.createElement('div');
                    Object.assign(aiMsg.style, {
                        background: '#ffffff',
                        padding: '12px 16px',
                        borderRadius: '16px 16px 16px 4px',
                        maxWidth: '85%',
                        alignSelf: 'flex-start',
                        wordWrap: 'break-word',
                        fontSize: '14px',
                        lineHeight: '1.5',
                        border: '1px solid #e5e7eb',
                        boxShadow: '0 1px 3px rgba(0,0,0,0.1)',
                        color: '#374151'
                    });
                    
                    const renderedHtml = renderMarkdown(item.content);
                    aiMsg.innerHTML = renderedHtml;
                    chatMessages.appendChild(aiMsg);
                    
                    renderMathInElement(aiMsg);
                }
            });
        }

        // Input Area
        const inputArea = document.createElement('div');
        Object.assign(inputArea.style, {
            padding: '20px',
            background: '#ffffff',
            borderTop: '1px solid #e5e7eb'
        });

        const inputContainer = document.createElement('div');
        Object.assign(inputContainer.style, {
            display: 'flex',
            gap: '6px',
            alignItems: 'flex-end',
            background: '#f8fafc',
            borderRadius: '16px',
            padding: '6px',
            border: '1px solid #e2e8f0'
        });

        // 画像アップロード用の隠しinput
        const imageInput = document.createElement('input');
        imageInput.type = 'file';
        imageInput.accept = 'image/*';
        imageInput.style.display = 'none';
        imageInput.id = 'image-input';

        // 画像アップロードボタン
        const imageBtn = document.createElement('button');
        imageBtn.innerHTML = '<i class="fas fa-paperclip"></i>';
        imageBtn.title = '画像をアップロード';
        Object.assign(imageBtn.style, {
            background: 'transparent',
            border: 'none',
            borderRadius: '6px',
            width: '32px',
            height: '32px',
            cursor: 'pointer',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            fontSize: '14px',
            transition: 'all 0.2s ease',
            color: '#6b7280'
        });

        // スクリーンキャプチャボタン
        const screenshotBtn = document.createElement('button');
        screenshotBtn.innerHTML = '<i class="fas fa-camera"></i>';
        screenshotBtn.title = 'スクリーンをキャプチャ';
        Object.assign(screenshotBtn.style, {
            background: 'transparent',
            border: 'none',
            borderRadius: '6px',
            width: '32px',
            height: '32px',
            cursor: 'pointer',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            fontSize: '14px',
            transition: 'all 0.2s ease',
            color: '#6b7280'
        });

        const chatInput = document.createElement('textarea');
        chatInput.id = 'chat-input';
        chatInput.placeholder = 'メッセージを入力...';
        Object.assign(chatInput.style, {
            flex: '1',
            background: 'transparent',
            border: 'none',
            borderRadius: '0',
            padding: '8px 12px',
            resize: 'none',
            maxHeight: '100px',
            fontFamily: 'inherit',
            fontSize: '14px',
            color: '#374151',
            outline: 'none',
            lineHeight: '1.5'
        });

        const sendBtn = document.createElement('button');
        sendBtn.id = 'send-btn';
        sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
        Object.assign(sendBtn.style, {
            background: '#3b82f6',
            border: 'none',
            borderRadius: '6px',
            width: '32px',
            height: '32px',
            cursor: 'pointer',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            fontSize: '14px',
            color: 'white',
            transition: 'all 0.2s ease'
        });

        // Event listeners
        imageBtn.addEventListener('click', () => {
            imageInput.click();
        });

        imageInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                sendImageToAI(file, chatInput.value.trim() || '画像について説明してください');
                chatInput.value = '';
                chatInput.style.height = 'auto';
            }
        });

        screenshotBtn.addEventListener('click', async () => {
            if (isIOS()) {
                showIOSCaptureAlert();
                return;
            }
            
            try {
                const stream = await navigator.mediaDevices.getDisplayMedia({
                    video: { mediaSource: 'screen' }
                });
                
                const video = document.createElement('video');
                video.srcObject = stream;
                video.play();
                
                video.addEventListener('loadedmetadata', () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(video, 0, 0);
                    
                    canvas.toBlob((blob) => {
                        sendScreenshotToAI(blob, chatInput.value.trim() || '画面の内容について説明してください');
                        chatInput.value = '';
                        stream.getTracks().forEach(track => track.stop());
                    });
                });
                
            } catch (error) {
                console.error('スクリーンキャプチャエラー:', error);
                alert('スクリーンキャプチャに失敗しました。');
            }
        });

        async function sendMessage() {
            const message = chatInput.value.trim();
            if (!message) return;

            chatInput.value = '';
            chatInput.style.height = 'auto';

            // チャット履歴にユーザーメッセージを保存
            chatHistory.push({
                type: 'user',
                content: message,
                timestamp: new Date()
            });

            // Add user message
            const userMsg = document.createElement('div');
            Object.assign(userMsg.style, {
                background: '#3b82f6',
                color: 'white',
                padding: '12px 16px',
                borderRadius: '16px 16px 4px 16px',
                maxWidth: '85%',
                alignSelf: 'flex-end',
                wordWrap: 'break-word',
                fontSize: '14px',
                lineHeight: '1.5',
                boxShadow: '0 1px 3px rgba(0,0,0,0.1)'
            });
            userMsg.textContent = message;
            chatMessages.appendChild(userMsg);
            chatMessages.scrollTop = chatMessages.scrollHeight;

            // AI response
            const aiMsg = document.createElement('div');
            Object.assign(aiMsg.style, {
                background: '#ffffff',
                padding: '12px 16px',
                borderRadius: '16px 16px 16px 4px',
                maxWidth: '85%',
                alignSelf: 'flex-start',
                wordWrap: 'break-word',
                fontSize: '14px',
                lineHeight: '1.5',
                border: '1px solid #e5e7eb',
                boxShadow: '0 1px 3px rgba(0,0,0,0.1)',
                color: '#374151'
            });
            aiMsg.textContent = '考え中...';
            chatMessages.appendChild(aiMsg);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            await sendTextToAI(message, aiMsg);
        }

        sendBtn.addEventListener('click', sendMessage);

        chatInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        chatInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });

        inputContainer.appendChild(imageBtn);
        inputContainer.appendChild(screenshotBtn);
        inputContainer.appendChild(chatInput);
        inputContainer.appendChild(sendBtn);
        inputArea.appendChild(imageInput);
        inputArea.appendChild(inputContainer);

        container.appendChild(chatMessages);
        container.appendChild(inputArea);

        winbox.body.appendChild(container);

        setTimeout(() => chatInput.focus(), 100);
    }

    // Function to open AI chat from navigation button
    function openAIChat() {
        createAIChat();
    }

    // スクリーンキャプチャ付きでAIチャットを開く関数
    async function openAIWithScreenshot() {
        createAIChat();
    }

    // テキストのみをAIに送信する関数
    async function sendTextToAI(message, responseElement) {
        let aiResponse = '';
        try {
            responseElement.textContent = '考え中...';

            const response = await fetch('/api/text', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ message })
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            responseElement.textContent = '';
            let buffer = '';

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                const chunk = decoder.decode(value, { stream: true });
                buffer += chunk;
                
                const lines = buffer.split('\n');
                buffer = lines.pop() || '';
                
                for (const line of lines) {
                    if (line.trim()) {
                        try {
                            const jsonData = JSON.parse(line);
                            if (jsonData.type === 'content' && jsonData.content) {
                                aiResponse += jsonData.content;
                                
                                const renderedHtml = renderMarkdown(aiResponse);
                                responseElement.innerHTML = renderedHtml;
                                
                                renderMathInElement(responseElement);
                                
                                const chatMessages = document.getElementById('chat-messages');
                                if (chatMessages) {
                                    chatMessages.scrollTop = chatMessages.scrollHeight;
                                }
                            } else if (jsonData.type === 'error') {
                                throw new Error(jsonData.error || 'テキスト処理中にエラーが発生しました');
                            }
                        } catch (parseError) {
                            console.warn('JSON解析エラー:', parseError, 'データ:', line);
                            if (!line.startsWith('{')) {
                                aiResponse += line;
                                const renderedHtml = renderMarkdown(aiResponse);
                                responseElement.innerHTML = renderedHtml;
                                renderMathInElement(responseElement);
                                
                                const chatMessages = document.getElementById('chat-messages');
                                if (chatMessages) {
                                    chatMessages.scrollTop = chatMessages.scrollHeight;
                                }
                            }
                        }
                    }
                }
            }

            if (aiResponse) {
                chatHistory.push({
                    type: 'ai',
                    content: aiResponse,
                    timestamp: new Date()
                });
            }

        } catch (error) {
            console.error('AI API Error:', error);
            const errorMsg = 'エラーが発生しました。Gemini APIキーが正しく設定されているか確認してください。';
            responseElement.textContent = errorMsg;
            
            chatHistory.push({
                type: 'ai',
                content: errorMsg,
                timestamp: new Date()
            });
        }
    }

    // 画像をAIに送信する関数
    async function sendImageToAI(imageFile, prompt) {
        const chatMessages = document.getElementById('chat-messages');
        if (!chatMessages) return;

        const imageUrl = URL.createObjectURL(imageFile);
        
        chatHistory.push({
            type: 'user',
            content: prompt,
            image: imageUrl,
            timestamp: new Date()
        });

        const userMsg = document.createElement('div');
        Object.assign(userMsg.style, {
            background: '#3b82f6',
            color: 'white',
            padding: '12px 16px',
            borderRadius: '16px 16px 4px 16px',
            maxWidth: '85%',
            alignSelf: 'flex-end',
            wordWrap: 'break-word',
            fontSize: '14px',
            lineHeight: '1.5',
            boxShadow: '0 1px 3px rgba(0,0,0,0.1)'
        });

        const imagePreview = document.createElement('img');
        imagePreview.src = imageUrl;
        Object.assign(imagePreview.style, {
            maxWidth: '200px',
            maxHeight: '200px',
            borderRadius: '8px',
            marginBottom: '8px',
            display: 'block'
        });
        
        const textPart = document.createElement('div');
        textPart.textContent = prompt;
        
        userMsg.appendChild(imagePreview);
        userMsg.appendChild(textPart);
        chatMessages.appendChild(userMsg);
        chatMessages.scrollTop = chatMessages.scrollHeight;

        const aiMsg = document.createElement('div');
        aiMsg.className = 'markdown-content';
        Object.assign(aiMsg.style, {
            background: '#ffffff',
            padding: '12px 16px',
            borderRadius: '16px 16px 16px 4px',
            maxWidth: '85%',
            alignSelf: 'flex-start',
            wordWrap: 'break-word',
            fontSize: '14px',
            lineHeight: '1.5',
            border: '1px solid #e5e7eb',
            boxShadow: '0 1px 3px rgba(0,0,0,0.1)',
            color: '#374151'
        });
        aiMsg.textContent = '分析中...';
        chatMessages.appendChild(aiMsg);
        chatMessages.scrollTop = chatMessages.scrollHeight;

        let aiResponse = '';
        try {
            const formData = new FormData();
            formData.append('image', imageFile);
            formData.append('prompt', prompt);

            const response = await fetch('/api/aireq', {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            aiMsg.textContent = '';
            let buffer = '';

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                const chunk = decoder.decode(value, { stream: true });
                buffer += chunk;
                
                const lines = buffer.split('\n');
                buffer = lines.pop() || '';
                
                for (const line of lines) {
                    if (line.trim()) {
                        try {
                            const jsonData = JSON.parse(line);
                            if (jsonData.type === 'content' && jsonData.content) {
                                aiResponse += jsonData.content;
                                
                                const renderedHtml = renderMarkdown(aiResponse);
                                aiMsg.innerHTML = renderedHtml;
                                
                                renderMathInElement(aiMsg);
                                chatMessages.scrollTop = chatMessages.scrollHeight;
                            } else if (jsonData.type === 'error') {
                                throw new Error(jsonData.error || '画像解析中にエラーが発生しました');
                            }
                        } catch (parseError) {
                            console.warn('JSON解析エラー:', parseError, 'データ:', line);
                            if (!line.startsWith('{')) {
                                aiResponse += line;
                                const renderedHtml = renderMarkdown(aiResponse);
                                aiMsg.innerHTML = renderedHtml;
                                renderMathInElement(aiMsg);
                                chatMessages.scrollTop = chatMessages.scrollHeight;
                            }
                        }
                    }
                }
            }

            if (aiResponse) {
                chatHistory.push({
                    type: 'ai',
                    content: aiResponse,
                    timestamp: new Date()
                });
            }

        } catch (error) {
            console.error('Image AI API Error:', error);
            const errorMsg = 'エラーが発生しました。画像の解析ができませんでした。';
            aiMsg.textContent = errorMsg;
            
            chatHistory.push({
                type: 'ai',
                content: errorMsg,
                timestamp: new Date()
            });
        }
    }

    // スクリーンショットをAIに送信する関数
    async function sendScreenshotToAI(imageBlob, prompt) {
        const chatMessages = document.getElementById('chat-messages');
        if (!chatMessages) return;

        const imageUrl = URL.createObjectURL(imageBlob);
        
        chatHistory.push({
            type: 'user',
            content: prompt,
            image: imageUrl,
            timestamp: new Date()
        });

        const userMsg = document.createElement('div');
        Object.assign(userMsg.style, {
            background: '#3b82f6',
            color: 'white',
            padding: '12px 16px',
            borderRadius: '16px 16px 4px 16px',
            maxWidth: '85%',
            alignSelf: 'flex-end',
            wordWrap: 'break-word',
            fontSize: '14px',
            lineHeight: '1.5',
            boxShadow: '0 1px 3px rgba(0,0,0,0.1)'
        });

        const imagePreview = document.createElement('img');
        imagePreview.src = imageUrl;
        Object.assign(imagePreview.style, {
            maxWidth: '200px',
            maxHeight: '200px',
            borderRadius: '8px',
            marginBottom: '8px',
            display: 'block'
        });
        
        const textPart = document.createElement('div');
        textPart.textContent = prompt;
        
        userMsg.appendChild(imagePreview);
        userMsg.appendChild(textPart);
        chatMessages.appendChild(userMsg);
        chatMessages.scrollTop = chatMessages.scrollHeight;

        const aiMsg = document.createElement('div');
        aiMsg.className = 'markdown-content';
        Object.assign(aiMsg.style, {
            background: '#ffffff',
            padding: '12px 16px',
            borderRadius: '16px 16px 16px 4px',
            maxWidth: '85%',
            alignSelf: 'flex-start',
            wordWrap: 'break-word',
            fontSize: '14px',
            lineHeight: '1.5',
            border: '1px solid #e5e7eb',
            boxShadow: '0 1px 3px rgba(0,0,0,0.1)',
            color: '#374151'
        });
        aiMsg.textContent = '画面を分析中...';
        chatMessages.appendChild(aiMsg);
        chatMessages.scrollTop = chatMessages.scrollHeight;

        let aiResponse = '';
        try {
            const formData = new FormData();
            formData.append('image', imageBlob, 'screenshot.png');
            formData.append('prompt', prompt);

            const response = await fetch('/api/aireq', {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            aiMsg.textContent = '';
            let buffer = '';

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                const chunk = decoder.decode(value, { stream: true });
                buffer += chunk;
                
                const lines = buffer.split('\n');
                buffer = lines.pop() || '';
                
                for (const line of lines) {
                    if (line.trim()) {
                        try {
                            const jsonData = JSON.parse(line);
                            if (jsonData.type === 'content' && jsonData.content) {
                                aiResponse += jsonData.content;
                                
                                const renderedHtml = renderMarkdown(aiResponse);
                                aiMsg.innerHTML = renderedHtml;
                                
                                renderMathInElement(aiMsg);
                                chatMessages.scrollTop = chatMessages.scrollHeight;
                            } else if (jsonData.type === 'error') {
                                throw new Error(jsonData.error || '画像解析中にエラーが発生しました');
                            }
                        } catch (parseError) {
                            console.warn('JSON解析エラー:', parseError, 'データ:', line);
                            if (!line.startsWith('{')) {
                                aiResponse += line;
                                const renderedHtml = renderMarkdown(aiResponse);
                                aiMsg.innerHTML = renderedHtml;
                                renderMathInElement(aiMsg);
                                chatMessages.scrollTop = chatMessages.scrollHeight;
                            }
                        }
                    }
                }
            }

            if (aiResponse) {
                chatHistory.push({
                    type: 'ai',
                    content: aiResponse,
                    timestamp: new Date()
                });
            }

        } catch (error) {
            console.error('Screenshot AI API Error:', error);
            const errorMsg = 'エラーが発生しました。スクリーンショットの解析ができませんでした。';
            aiMsg.textContent = errorMsg;
            
            chatHistory.push({
                type: 'ai',
                content: errorMsg,
                timestamp: new Date()
            });
        }
    }

  </script>
  <script src="assets/js/iframe-proxy.js"></script>
</body>

</html>
