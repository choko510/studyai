<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="referrer" content="no-referrer" />
  <meta http-equiv="X-Content-Type-Options" content="nosniff" />
  <meta http-equiv="Content-Security-Policy" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title id="t">Interstellar Proxy</title>
  <link rel="stylesheet" href="assets/css/main.css">
    <link rel="manifest" href="manifest.json">
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #1a1a1a;
      color: white;
      overflow: hidden;
    }
    
    .proxy-container {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    
    .url-bar {
      background: #2d2d2d;
      padding: 12px;
      border-bottom: 1px solid #444;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .nav-buttons {
      display: flex;
      gap: 8px;
    }
    
    .nav-btn {
      background: #2d3748;
      border: none;
      color: white;
      padding: 10px 14px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 500;
      transition: all 0.2s ease;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      position: relative;
      overflow: hidden;
    }
    
    .nav-btn:hover:not(:disabled) {
      background: #4a5568;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .nav-btn:active:not(:disabled) {
      transform: translateY(0);
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
    }
    
    .nav-btn:disabled {
      background: #1a202c;
      color: #4a5568;
      cursor: not-allowed;
      opacity: 0.6;
      transform: none;
      box-shadow: none;
    }
    
    .nav-btn::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      background: rgba(255,255,255,0.1);
      border-radius: 50%;
      transition: all 0.3s ease;
      transform: translate(-50%, -50%);
    }
    
    .nav-btn:hover:not(:disabled)::before {
      width: 100px;
      height: 100px;
    }
    
    .url-input {
      flex: 1;
      background: #1a202c;
      border: 2px solid #2d3748;
      color: white;
      padding: 12px 16px;
      border-radius: 12px;
      font-size: 16px;
      outline: none;
      transition: all 0.3s ease;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .url-input:focus {
      border-color: #667eea;
      background: #2d3748;
      box-shadow:
        inset 0 2px 4px rgba(0,0,0,0.1),
        0 0 0 3px rgba(102, 126, 234, 0.1);
      transform: translateY(-1px);
    }
    
    .url-input::placeholder {
      color: #a0aec0;
      opacity: 0.8;
    }
    
    .go-btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
      color: white;
      padding: 12px 24px;
      border-radius: 12px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
      position: relative;
      overflow: hidden;
    }
    
    .go-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
      background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
    }
    
    .go-btn:active {
      transform: translateY(0);
      box-shadow: 0 2px 10px rgba(102, 126, 234, 0.3);
    }
    
    .go-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.5s;
    }
    
    .go-btn:hover::before {
      left: 100%;
    }
    
    .iframe-container {
      flex: 1;
      position: relative;
      background: white;
    }
    
    .proxy-iframe {
      width: 100%;
      height: 100%;
      border: none;
      background: white;
    }
    
    .loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #666;
      font-size: 18px;
    }
    
    .error-message {
      background: #ff4444;
      color: white;
      padding: 10px;
      margin: 10px;
      border-radius: 6px;
      display: none;
    }
  </style>
</head>

<body>
  <div class="proxy-container">
    <div class="url-bar">
      <div class="nav-buttons">
        <button class="nav-btn" id="back-btn" onclick="goBack()" disabled>â†</button>
        <button class="nav-btn" id="forward-btn" onclick="goForward()" disabled>â†’</button>
        <button class="nav-btn" id="refresh-btn" onclick="refresh()">âŸ²</button>
        <button class="nav-btn" id="ai-btn" onclick="openAIWithScreenshot()">AIè³ªå•</button>
      </div>
      <input type="text" class="url-input" id="url-input" placeholder="URLã¾ãŸã¯æ¤œç´¢èªå¥ã‚’å…¥åŠ›..." value="https://google.com">
      <button class="go-btn" onclick="navigate()">ç§»å‹•</button>
    </div>
    
    <div class="error-message" id="error-message"></div>
    
    <div class="iframe-container">
      <div class="loading" id="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
      <iframe class="proxy-iframe" id="proxy-iframe" sandbox="allow-same-origin allow-scripts allow-forms allow-popups allow-top-navigation-by-user-activation"></iframe>
    </div>
  </div>

  <script src="./assets/mathematics/bundle.js?v=2025-06-01"></script>
  <script src="./assets/mathematics/config.js?v=2025-06-01"></script>
  <script src="https://cdn.jsdelivr.net/npm/dom-to-image-more@3.6.0/dist/dom-to-image-more.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/dom-to-image-more@3.6.0/spec/resources/fonts/web-fonts/embedded.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/winbox@0.2.82/dist/winbox.bundle.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/winbox@0.2.82/dist/css/winbox.min.css" rel="stylesheet">

  <script>
    // Service Workerã‚’iframeãƒ—ãƒ­ã‚­ã‚·ç”¨ã«ç™»éŒ²
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js?v=2025-06-01', {
          scope: '/'
        }).then((registration) => {
          console.log('Service Worker registered for iframe proxy:', registration);
        }).catch((error) => {
          console.error('Service Worker registration failed:', error);
        });
      });
    }

    function setupRightClickPaint(doc) {
        const canvas = doc.createElement('canvas');
        canvas.style.position = 'fixed';
        canvas.style.top = '0';
        canvas.style.left = '0';
        canvas.style.pointerEvents = 'none';
        canvas.width = doc.documentElement.clientWidth;
        canvas.height = doc.documentElement.clientHeight;
        canvas.style.zIndex = 9999;
        doc.body.appendChild(canvas);

        const ctx = canvas.getContext('2d');
        const paintColor = 'red';
        const brushSize = 3;
        let isPainting = false;
        let lastX = 0;
        let lastY = 0;
        let currentPath = []; // ç¾åœ¨æç”»ä¸­ã®ãƒ‘ã‚¹
        let completedPaths = []; // å®Œæˆã—ãŸãƒ‘ã‚¹

        // ãƒšã‚¤ãƒ³ãƒˆè¨­å®š
        ctx.strokeStyle = paintColor;
        ctx.lineWidth = brushSize;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';

        doc.addEventListener('contextmenu', (e) => e.preventDefault());

        doc.addEventListener('mousedown', (e) => {
            if (e.button === 2) {
                isPainting = true;
                canvas.style.pointerEvents = 'auto';
                [lastX, lastY] = [e.clientX, e.clientY];
                
                // æ–°ã—ã„ãƒ‘ã‚¹ã‚’é–‹å§‹
                currentPath = [{x: lastX, y: lastY}];
                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
            }
        });

        doc.addEventListener('mouseup', (e) => {
            if (e.button === 2) {
                isPainting = false;
                canvas.style.pointerEvents = 'none';
                
                // ãƒ‘ã‚¹ãŒé–‰ã˜ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆé–‹å§‹ç‚¹ã¨çµ‚äº†ç‚¹ãŒè¿‘ã„å ´åˆï¼‰
                if (currentPath.length > 10) { // æœ€ä½é™ã®é•·ã•ãŒå¿…è¦
                    const startPoint = currentPath[0];
                    const endPoint = currentPath[currentPath.length - 1];
                    const distance = Math.sqrt(
                        Math.pow(startPoint.x - endPoint.x, 2) +
                        Math.pow(startPoint.y - endPoint.y, 2)
                    );
                    
                    // 50ãƒ”ã‚¯ã‚»ãƒ«ä»¥å†…ãªã‚‰é–‰ã˜ãŸå›³å½¢ã¨ã¿ãªã™
                    if (distance < 50) {
                        // é–‰ã˜ãŸå›³å½¢ã¨ã—ã¦å‡¦ç†
                        ctx.closePath();
                        completedPaths.push([...currentPath]);
                        
                        // AIã«é€ä¿¡ã™ã‚‹ã‹ç¢ºèª
                        showMarkerConfirmDialog(doc, currentPath, canvas, ctx);
                    }
                }
                
                currentPath = [];
                ctx.beginPath(); // ãƒ‘ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆ
            }
        });

        doc.addEventListener('mousemove', (e) => {
            if (isPainting) {
                currentPath.push({x: e.clientX, y: e.clientY});
                ctx.lineTo(e.clientX, e.clientY);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(e.clientX, e.clientY);
            }
        });
    }

    // ãƒãƒ¼ã‚«ãƒ¼ç¯„å›²ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
    function showMarkerConfirmDialog(doc, markerPath, canvas, ctx) {
        // æ—¢å­˜ã®ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒã‚ã‚Œã°å‰Šé™¤
        const existingDialog = doc.getElementById('marker-confirm-dialog');
        if (existingDialog) {
            existingDialog.remove();
        }

        // ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’ä½œæˆ
        const dialog = doc.createElement('div');
        dialog.id = 'marker-confirm-dialog';
        Object.assign(dialog.style, {
            position: 'fixed',
            top: '50%',
            left: '50%',
            transform: 'translate(-50%, -50%)',
            background: 'white',
            borderRadius: '12px',
            padding: '24px',
            boxShadow: '0 10px 40px rgba(0,0,0,0.3)',
            zIndex: 10000,
            fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
            color: '#1a1a1a',
            minWidth: '300px',
            textAlign: 'center'
        });

        dialog.innerHTML = `
            <h3 style="margin: 0 0 16px 0; font-size: 18px; color: #374151;">ãƒãƒ¼ã‚«ãƒ¼ç¯„å›²ã‚’æ¤œå‡º</h3>
            <p style="margin: 0 0 24px 0; font-size: 14px; color: #6b7280; line-height: 1.5;">
                ã“ã®ç¯„å›²ã‚’AIã«é€ä¿¡ã—ã¦åˆ†æã—ã¾ã™ã‹ï¼Ÿ
            </p>
            <div style="display: flex; gap: 12px; justify-content: center;">
                <button id="confirm-yes" style="
                    background: #3b82f6;
                    color: white;
                    border: none;
                    padding: 10px 20px;
                    border-radius: 8px;
                    cursor: pointer;
                    font-size: 14px;
                    font-weight: 500;
                ">ã¯ã„</button>
                <button id="confirm-no" style="
                    background: #6b7280;
                    color: white;
                    border: none;
                    padding: 10px 20px;
                    border-radius: 8px;
                    cursor: pointer;
                    font-size: 14px;
                    font-weight: 500;
                ">ã„ã„ãˆ</button>
            </div>
        `;

        doc.body.appendChild(dialog);

        // ãƒãƒ¼ã‚«ãƒ¼ã‚’æ¶ˆå»ã™ã‚‹é–¢æ•°
        function clearMarker() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        const yesBtn = dialog.querySelector('#confirm-yes');
        const noBtn = dialog.querySelector('#confirm-no');

        yesBtn.addEventListener('click', () => {
            captureMarkedArea(doc, markerPath);
            clearMarker(); // ãƒãƒ¼ã‚«ãƒ¼ã‚’æ¶ˆå»
            dialog.remove();
        });

        noBtn.addEventListener('click', () => {
            clearMarker(); // ãƒãƒ¼ã‚«ãƒ¼ã‚’æ¶ˆå»
            dialog.remove();
        });

        // 3ç§’å¾Œã«è‡ªå‹•ã§é–‰ã˜ã‚‹ï¼ˆãƒãƒ¼ã‚«ãƒ¼ã‚‚æ¶ˆå»ï¼‰
        setTimeout(() => {
            if (dialog.parentNode) {
                clearMarker();
                dialog.remove();
            }
        }, 3000);
    }

    // ãƒãƒ¼ã‚«ãƒ¼ã§å›²ã¾ã‚ŒãŸç¯„å›²ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£ã—ã¦AIã«é€ä¿¡
    async function captureMarkedArea(doc, markerPath) {
        try {
            // ãƒãƒ¼ã‚«ãƒ¼ãƒ‘ã‚¹ã®ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ã‚’è¨ˆç®—
            const minX = Math.min(...markerPath.map(p => p.x));
            const maxX = Math.max(...markerPath.map(p => p.x));
            const minY = Math.min(...markerPath.map(p => p.y));
            const maxY = Math.max(...markerPath.map(p => p.y));

            // ãƒãƒ¼ã‚«ãƒ¼ã®ä¸­å¿ƒç‚¹ã‚’è¨ˆç®—
            const centerX = (minX + maxX) / 2;
            const centerY = (minY + maxY) / 2;

            // ãƒãƒ¼ã‚«ãƒ¼ã®ã‚µã‚¤ã‚ºã‚’è¨ˆç®—
            const markerWidth = maxX - minX;
            const markerHeight = maxY - minY;

            // ååˆ†ãªä½™ç™½ã‚’è¿½åŠ ï¼ˆãƒãƒ¼ã‚«ãƒ¼ã‚µã‚¤ã‚ºã®50%ã€æœ€ä½100ãƒ”ã‚¯ã‚»ãƒ«ï¼‰
            const paddingX = Math.max(markerWidth * 0.5, 100);
            const paddingY = Math.max(markerHeight * 0.5, 100);

            // ã‚­ãƒ£ãƒ—ãƒãƒ£ç¯„å›²ã‚’ä¸­å¿ƒç‚¹ã‹ã‚‰è¨ˆç®—
            const cropWidth = markerWidth + paddingX * 2;
            const cropHeight = markerHeight + paddingY * 2;
            const cropX = centerX - cropWidth / 2;
            const cropY = centerY - cropHeight / 2;

            // ç”»é¢å¢ƒç•Œå†…ã«èª¿æ•´
            const screenWidth = window.innerWidth;
            const screenHeight = window.innerHeight;
            
            let adjustedCropX = cropX;
            let adjustedCropY = cropY;
            let adjustedCropWidth = cropWidth;
            let adjustedCropHeight = cropHeight;

            // å·¦ç«¯èª¿æ•´
            if (adjustedCropX < 0) {
                adjustedCropX = 0;
            }
            // å³ç«¯èª¿æ•´
            if (adjustedCropX + adjustedCropWidth > screenWidth) {
                adjustedCropX = screenWidth - adjustedCropWidth;
                if (adjustedCropX < 0) {
                    adjustedCropX = 0;
                    adjustedCropWidth = screenWidth;
                }
            }
            // ä¸Šç«¯èª¿æ•´
            if (adjustedCropY < 0) {
                adjustedCropY = 0;
            }
            // ä¸‹ç«¯èª¿æ•´
            if (adjustedCropY + adjustedCropHeight > screenHeight) {
                adjustedCropY = screenHeight - adjustedCropHeight;
                if (adjustedCropY < 0) {
                    adjustedCropY = 0;
                    adjustedCropHeight = screenHeight;
                }
            }

            console.log('ãƒãƒ¼ã‚«ãƒ¼ç¯„å›²:', {
                marker: { minX, maxX, minY, maxY, centerX, centerY },
                crop: { x: adjustedCropX, y: adjustedCropY, width: adjustedCropWidth, height: adjustedCropHeight },
                screen: { width: screenWidth, height: screenHeight }
            });

            // ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚­ãƒ£ãƒ—ãƒãƒ£APIã‚’ä½¿ç”¨
            if (isScreenCaptureActive && screenCaptureVideo) {
                const fullCanvas = document.createElement('canvas');
                fullCanvas.width = screenCaptureVideo.videoWidth;
                fullCanvas.height = screenCaptureVideo.videoHeight;
                const fullCtx = fullCanvas.getContext('2d');
                fullCtx.drawImage(screenCaptureVideo, 0, 0);
                
                // ã‚¹ã‚±ãƒ¼ãƒ«æ¯”ã‚’è¨ˆç®—
                const scaleX = screenCaptureVideo.videoWidth / screenWidth;
                const scaleY = screenCaptureVideo.videoHeight / screenHeight;
                
                // å®Ÿéš›ã®ã‚­ãƒ£ãƒ—ãƒãƒ£ç¯„å›²ã‚’è¨ˆç®—
                const finalCropX = adjustedCropX * scaleX;
                const finalCropY = adjustedCropY * scaleY;
                const finalCropWidth = adjustedCropWidth * scaleX;
                const finalCropHeight = adjustedCropHeight * scaleY;
                
                console.log('å®Ÿéš›ã®ã‚­ãƒ£ãƒ—ãƒãƒ£ç¯„å›²:', {
                    x: finalCropX, y: finalCropY,
                    width: finalCropWidth, height: finalCropHeight,
                    scale: { x: scaleX, y: scaleY },
                    videoSize: { width: screenCaptureVideo.videoWidth, height: screenCaptureVideo.videoHeight }
                });
                
                const cropCanvas = document.createElement('canvas');
                cropCanvas.width = finalCropWidth;
                cropCanvas.height = finalCropHeight;
                const cropCtx = cropCanvas.getContext('2d');
                
                cropCtx.drawImage(
                    fullCanvas,
                    finalCropX, finalCropY, finalCropWidth, finalCropHeight,
                    0, 0, cropCanvas.width, cropCanvas.height
                );
                
                cropCanvas.toBlob((blob) => {
                    sendMarkedAreaToAI(blob);
                });
            } else {
                alert('ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚­ãƒ£ãƒ—ãƒãƒ£ãŒæœ‰åŠ¹ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚AIãƒãƒ£ãƒƒãƒˆã§ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚­ãƒ£ãƒ—ãƒãƒ£ã‚’æœ‰åŠ¹ã«ã—ã¦ãã ã•ã„ã€‚');
            }
        } catch (error) {
            console.error('ãƒãƒ¼ã‚«ãƒ¼ç¯„å›²ã‚­ãƒ£ãƒ—ãƒãƒ£ã‚¨ãƒ©ãƒ¼:', error);
            alert('ç¯„å›²ã®ã‚­ãƒ£ãƒ—ãƒãƒ£ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
        }
    }

    // ãƒãƒ¼ã‚«ãƒ¼ç¯„å›²ã‚’AIã«é€ä¿¡
    function sendMarkedAreaToAI(imageBlob) {
        // AIãƒãƒ£ãƒƒãƒˆãŒé–‹ã„ã¦ã„ãªã„å ´åˆã¯é–‹ã
        if (!document.getElementById('chat-messages')) {
            createAIChat();
            
            // å°‘ã—å¾…ã£ã¦ã‹ã‚‰é€ä¿¡
            setTimeout(() => {
                sendScreenshotToAI(imageBlob, 'ãƒãƒ¼ã‚«ãƒ¼ã§å›²ã‚“ã ç¯„å›²ã«ã¤ã„ã¦èª¬æ˜ã—ã¦ãã ã•ã„');
            }, 500);
        } else {
            sendScreenshotToAI(imageBlob, 'ãƒãƒ¼ã‚«ãƒ¼ã§å›²ã‚“ã ç¯„å›²ã«ã¤ã„ã¦èª¬æ˜ã—ã¦ãã ã•ã„');
        }
    }

    // è¦ªãƒšãƒ¼ã‚¸ã«é©ç”¨
    setupRightClickPaint(document);

    // iframeã«é©ç”¨ã™ã‚‹é–¢æ•°
    function applyToIframe(iframe) {
        try {
            if (iframe.contentDocument) {
                setupRightClickPaint(iframe.contentDocument);
            }
        } catch (e) {
            console.warn('iframeã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“:', e);
        }
    }

    // æ—¢å­˜ã®iframeã«é©ç”¨
    document.querySelectorAll('iframe').forEach(applyToIframe);

    // iframeã®å†…å®¹ãŒå¤‰æ›´ã•ã‚ŒãŸæ™‚ã®ç›£è¦–
    const observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
            mutation.addedNodes.forEach((node) => {
                if (node.nodeType === 1 && node.tagName === 'IFRAME') {
                    node.addEventListener('load', () => applyToIframe(node));
                }
            });
        });
    });

    observer.observe(document.body, { childList: true, subtree: true });

    // ãƒ—ãƒ­ã‚­ã‚·iframeã®èª­ã¿è¾¼ã¿å®Œäº†ã‚’ç›£è¦–
    const proxyIframe = document.getElementById('proxy-iframe');
    if (proxyIframe) {
        proxyIframe.addEventListener('load', () => {
            applyToIframe(proxyIframe);
        });
    }


    // AI Chat functionality
    let chatHistory = []; // ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’ä¿å­˜
    
    function createAIChat() {
        const winbox = new WinBox({
            title: "AI Assistant",
            width: 380,
            height: 580,
            x: "right",
            y: "center"
        });

        // Create the chat UI dynamically
        const container = document.createElement('div');
        container.id = 'ai-chat-container';
        Object.assign(container.style, {
            display: 'flex',
            flexDirection: 'column',
            height: '100%',
            fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
            background: '#ffffff',
            color: '#1a1a1a'
        });

        // Header - Simple and clean
        const header = document.createElement('div');
        Object.assign(header.style, {
            padding: '20px',
            borderBottom: '1px solid #e5e7eb',
            textAlign: 'center'
        });

        const title = document.createElement('h2');
        Object.assign(title.style, {
            margin: '0',
            fontSize: '18px',
            fontWeight: '600',
            color: '#374151'
        });
        title.textContent = 'AI Assistant';

        const subtitle = document.createElement('p');
        Object.assign(subtitle.style, {
            margin: '4px 0 0 0',
            fontSize: '12px',
            color: '#9ca3af'
        });
        subtitle.textContent = 'ãƒ†ã‚­ã‚¹ãƒˆã‚„ç”»åƒã«ã¤ã„ã¦è³ªå•ã—ã¦ãã ã•ã„';

        header.appendChild(title);
        header.appendChild(subtitle);

        // Chat Messages
        const chatMessages = document.createElement('div');
        chatMessages.id = 'chat-messages';
        Object.assign(chatMessages.style, {
            flex: '1',
            padding: '20px',
            overflowY: 'auto',
            display: 'flex',
            flexDirection: 'column',
            gap: '12px',
            background: '#f8fafc'
        });

        // æ—¢å­˜ã®ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’è¡¨ç¤º
        if (chatHistory.length === 0) {
            const welcomeMsg = document.createElement('div');
            Object.assign(welcomeMsg.style, {
                background: '#ffffff',
                padding: '12px 16px',
                borderRadius: '16px',
                boxShadow: '0 1px 3px rgba(0,0,0,0.1)',
                maxWidth: '85%',
                alignSelf: 'flex-start',
                border: '1px solid #e5e7eb',
                fontSize: '14px',
                lineHeight: '1.5'
            });
            welcomeMsg.textContent = 'ã“ã‚“ã«ã¡ã¯ï¼ä½•ã‹ãŠæ‰‹ä¼ã„ã§ãã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ';
            chatMessages.appendChild(welcomeMsg);
        } else {
            // æ—¢å­˜ã®å±¥æ­´ã‚’è¡¨ç¤º
            chatHistory.forEach(item => {
                if (item.type === 'user') {
                    const userMsg = document.createElement('div');
                    Object.assign(userMsg.style, {
                        background: '#3b82f6',
                        color: 'white',
                        padding: '12px 16px',
                        borderRadius: '16px 16px 4px 16px',
                        maxWidth: '85%',
                        alignSelf: 'flex-end',
                        wordWrap: 'break-word',
                        fontSize: '14px',
                        lineHeight: '1.5',
                        boxShadow: '0 1px 3px rgba(0,0,0,0.1)'
                    });
                    
                    if (item.image) {
                        const imagePreview = document.createElement('img');
                        imagePreview.src = item.image;
                        Object.assign(imagePreview.style, {
                            maxWidth: '200px',
                            maxHeight: '200px',
                            borderRadius: '8px',
                            marginBottom: '8px',
                            display: 'block'
                        });
                        userMsg.appendChild(imagePreview);
                    }
                    
                    const textPart = document.createElement('div');
                    textPart.textContent = item.content;
                    userMsg.appendChild(textPart);
                    chatMessages.appendChild(userMsg);
                } else if (item.type === 'ai') {
                    const aiMsg = document.createElement('div');
                    Object.assign(aiMsg.style, {
                        background: '#ffffff',
                        padding: '12px 16px',
                        borderRadius: '16px 16px 16px 4px',
                        maxWidth: '85%',
                        alignSelf: 'flex-start',
                        wordWrap: 'break-word',
                        fontSize: '14px',
                        lineHeight: '1.5',
                        border: '1px solid #e5e7eb',
                        boxShadow: '0 1px 3px rgba(0,0,0,0.1)',
                        color: '#374151'
                    });
                    aiMsg.textContent = item.content;
                    chatMessages.appendChild(aiMsg);
                }
            });
        }

        // Input Area
        const inputArea = document.createElement('div');
        Object.assign(inputArea.style, {
            padding: '20px',
            background: '#ffffff',
            borderTop: '1px solid #e5e7eb'
        });

        const inputContainer = document.createElement('div');
        Object.assign(inputContainer.style, {
            display: 'flex',
            gap: '8px',
            alignItems: 'flex-end',
            background: '#f1f5f9',
            borderRadius: '24px',
            padding: '8px'
        });

        // ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç”¨ã®éš ã—input
        const imageInput = document.createElement('input');
        imageInput.type = 'file';
        imageInput.accept = 'image/*';
        imageInput.style.display = 'none';
        imageInput.id = 'image-input';

        // ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³
        const imageBtn = document.createElement('button');
        imageBtn.textContent = 'ğŸ“';
        imageBtn.title = 'ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰';
        Object.assign(imageBtn.style, {
            background: 'transparent',
            border: 'none',
            borderRadius: '50%',
            width: '36px',
            height: '36px',
            cursor: 'pointer',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            fontSize: '16px',
            transition: 'all 0.2s ease',
            color: '#6b7280'
        });

        // ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚­ãƒ£ãƒ—ãƒãƒ£ãƒœã‚¿ãƒ³
        const screenshotBtn = document.createElement('button');
        screenshotBtn.textContent = 'ğŸ“·';
        screenshotBtn.title = 'ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£';
        Object.assign(screenshotBtn.style, {
            background: 'transparent',
            border: 'none',
            borderRadius: '50%',
            width: '36px',
            height: '36px',
            cursor: 'pointer',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            fontSize: '16px',
            transition: 'all 0.2s ease',
            color: '#6b7280'
        });

        const chatInput = document.createElement('textarea');
        chatInput.id = 'chat-input';
        chatInput.placeholder = 'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›...';
        Object.assign(chatInput.style, {
            flex: '1',
            background: 'transparent',
            border: 'none',
            borderRadius: '0',
            padding: '8px 12px',
            resize: 'none',
            maxHeight: '100px',
            fontFamily: 'inherit',
            fontSize: '14px',
            color: '#374151',
            outline: 'none',
            lineHeight: '1.5'
        });

        const sendBtn = document.createElement('button');
        sendBtn.id = 'send-btn';
        sendBtn.textContent = 'â†’';
        Object.assign(sendBtn.style, {
            background: '#3b82f6',
            border: 'none',
            borderRadius: '50%',
            width: '36px',
            height: '36px',
            cursor: 'pointer',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            fontSize: '14px',
            fontWeight: 'bold',
            color: 'white',
            transition: 'all 0.2s ease'
        });

        // ç”»åƒãƒœã‚¿ãƒ³ã®ãƒ›ãƒãƒ¼ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
        imageBtn.addEventListener('mouseover', () => {
            imageBtn.style.background = '#e2e8f0';
            imageBtn.style.color = '#374151';
        });
        imageBtn.addEventListener('mouseout', () => {
            imageBtn.style.background = 'transparent';
            imageBtn.style.color = '#6b7280';
        });

        // ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚­ãƒ£ãƒ—ãƒãƒ£ãƒœã‚¿ãƒ³ã®ãƒ›ãƒãƒ¼ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
        screenshotBtn.addEventListener('mouseover', () => {
            screenshotBtn.style.background = '#e2e8f0';
            screenshotBtn.style.color = '#374151';
        });
        screenshotBtn.addEventListener('mouseout', () => {
            screenshotBtn.style.background = 'transparent';
            screenshotBtn.style.color = '#6b7280';
        });

        // é€ä¿¡ãƒœã‚¿ãƒ³ã®ãƒ›ãƒãƒ¼ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
        sendBtn.addEventListener('mouseover', () => {
            sendBtn.style.background = '#2563eb';
            sendBtn.style.transform = 'scale(1.05)';
        });
        sendBtn.addEventListener('mouseout', () => {
            sendBtn.style.background = '#3b82f6';
            sendBtn.style.transform = 'scale(1)';
        });

        // ç”»åƒãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
        imageBtn.addEventListener('click', () => {
            imageInput.click();
        });

        // ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚­ãƒ£ãƒ—ãƒãƒ£ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
        screenshotBtn.addEventListener('click', async () => {
            if (isScreenCaptureActive) {
                // æ—¢ã«ã‚­ãƒ£ãƒ—ãƒãƒ£ãŒæœ‰åŠ¹ãªå ´åˆã¯åœæ­¢
                if (screenCaptureStream) {
                    screenCaptureStream.getTracks().forEach(track => track.stop());
                }
                isScreenCaptureActive = false;
                screenCaptureStream = null;
                screenCaptureVideo = null;
                
                // åœæ­¢ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                const infoMsg = document.createElement('div');
                Object.assign(infoMsg.style, {
                    background: '#f3f4f6',
                    padding: '12px 16px',
                    borderRadius: '16px',
                    maxWidth: '85%',
                    alignSelf: 'center',
                    fontSize: '12px',
                    color: '#6b7280',
                    textAlign: 'center',
                    margin: '8px auto',
                    border: '1px solid #d1d5db'
                });
                infoMsg.textContent = 'ğŸ“· ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚­ãƒ£ãƒ—ãƒãƒ£ã‚’åœæ­¢ã—ã¾ã—ãŸã€‚';
                chatMessages.appendChild(infoMsg);
                chatMessages.scrollTop = chatMessages.scrollHeight;
                
            } else {
                // æ–°ã—ã„ã‚­ãƒ£ãƒ—ãƒãƒ£ã‚’é–‹å§‹
                try {
                    screenCaptureStream = await navigator.mediaDevices.getDisplayMedia({
                        video: { mediaSource: 'screen' }
                    });
                    
                    screenCaptureVideo = document.createElement('video');
                    screenCaptureVideo.srcObject = screenCaptureStream;
                    screenCaptureVideo.play();
                    
                    // ã‚¹ãƒˆãƒªãƒ¼ãƒ ãŒçµ‚äº†ã—ãŸæ™‚ã®å‡¦ç†
                    screenCaptureStream.getVideoTracks()[0].addEventListener('ended', () => {
                        isScreenCaptureActive = false;
                        screenCaptureStream = null;
                        screenCaptureVideo = null;
                    });
                    
                    screenCaptureVideo.addEventListener('loadedmetadata', () => {
                        isScreenCaptureActive = true;
                        
                        // ã‚­ãƒ£ãƒ—ãƒãƒ£é–‹å§‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                        const infoMsg = document.createElement('div');
                        Object.assign(infoMsg.style, {
                            background: '#dbeafe',
                            padding: '12px 16px',
                            borderRadius: '16px',
                            maxWidth: '85%',
                            alignSelf: 'center',
                            fontSize: '12px',
                            color: '#1e40af',
                            textAlign: 'center',
                            margin: '8px auto',
                            border: '1px solid #bfdbfe'
                        });
                        infoMsg.textContent = 'ğŸ“· ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚­ãƒ£ãƒ—ãƒãƒ£ãƒ¢ãƒ¼ãƒ‰æœ‰åŠ¹ã€‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡æ™‚ã«ç¾åœ¨ã®ç”»é¢ã‚‚é€ä¿¡ã•ã‚Œã¾ã™ã€‚';
                        chatMessages.appendChild(infoMsg);
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                    });
                    
                } catch (error) {
                    console.error('ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚­ãƒ£ãƒ—ãƒãƒ£ã‚¨ãƒ©ãƒ¼:', error);
                    // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                    const errorMsg = document.createElement('div');
                    Object.assign(errorMsg.style, {
                        background: '#fef2f2',
                        padding: '12px 16px',
                        borderRadius: '16px',
                        maxWidth: '85%',
                        alignSelf: 'center',
                        fontSize: '12px',
                        color: '#dc2626',
                        textAlign: 'center',
                        margin: '8px auto',
                        border: '1px solid #fecaca'
                    });
                    errorMsg.textContent = 'ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚­ãƒ£ãƒ—ãƒãƒ£ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
                    chatMessages.appendChild(errorMsg);
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }
            }
        });

        // ç”»åƒé¸æŠæ™‚ã®ã‚¤ãƒ™ãƒ³ãƒˆ
        imageInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                sendImageToAI(file, chatInput.value.trim() || 'ç”»åƒã«ã¤ã„ã¦èª¬æ˜ã—ã¦ãã ã•ã„');
                chatInput.value = '';
                chatInput.style.height = 'auto';
            }
        });

        inputContainer.appendChild(imageBtn);
        inputContainer.appendChild(screenshotBtn);
        inputContainer.appendChild(chatInput);
        inputContainer.appendChild(sendBtn);
        inputArea.appendChild(imageInput);
        inputArea.appendChild(inputContainer);

        // Assemble the UI
        container.appendChild(header);
        container.appendChild(chatMessages);
        container.appendChild(inputArea);

        // Set the content to WinBox
        winbox.body.appendChild(container);

        // Add functionality
        chatInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });

        async function sendMessage() {
            const message = chatInput.value.trim();
            if (!message) return;

            // Clear input first
            chatInput.value = '';
            chatInput.style.height = 'auto';

            // ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚­ãƒ£ãƒ—ãƒãƒ£ãŒæœ‰åŠ¹ãªå ´åˆã¯ã€ç¾åœ¨ã®ç”»é¢ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£ã—ã¦é€ä¿¡
            if (isScreenCaptureActive) {
                try {
                    const screenBlob = await captureCurrentScreen();
                    sendScreenshotToAI(screenBlob, message);
                } catch (error) {
                    console.error('ç”»é¢ã‚­ãƒ£ãƒ—ãƒãƒ£ã‚¨ãƒ©ãƒ¼:', error);
                    // ã‚­ãƒ£ãƒ—ãƒãƒ£ã«å¤±æ•—ã—ãŸå ´åˆã¯é€šå¸¸ã®ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
                    sendNormalTextMessage(message);
                }
            } else {
                // é€šå¸¸ã®ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
                sendNormalTextMessage(message);
            }
        }

        function sendNormalTextMessage(message) {
            // ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä¿å­˜
            chatHistory.push({
                type: 'user',
                content: message,
                timestamp: new Date()
            });

            // Add user message
            const userMsg = document.createElement('div');
            Object.assign(userMsg.style, {
                background: '#3b82f6',
                color: 'white',
                padding: '12px 16px',
                borderRadius: '16px 16px 4px 16px',
                maxWidth: '85%',
                alignSelf: 'flex-end',
                wordWrap: 'break-word',
                fontSize: '14px',
                lineHeight: '1.5',
                boxShadow: '0 1px 3px rgba(0,0,0,0.1)'
            });
            userMsg.textContent = message;
            chatMessages.appendChild(userMsg);

            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;

            // AI response
            const aiMsg = document.createElement('div');
            Object.assign(aiMsg.style, {
                background: '#ffffff',
                padding: '12px 16px',
                borderRadius: '16px 16px 16px 4px',
                maxWidth: '85%',
                alignSelf: 'flex-start',
                wordWrap: 'break-word',
                fontSize: '14px',
                lineHeight: '1.5',
                border: '1px solid #e5e7eb',
                boxShadow: '0 1px 3px rgba(0,0,0,0.1)',
                color: '#374151'
            });
            
            // AIã‹ã‚‰ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¡¨ç¤º
            aiMsg.textContent = '';
            chatMessages.appendChild(aiMsg);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // ãƒ†ã‚­ã‚¹ãƒˆã®ã¿ã®å ´åˆã®APIå‘¼ã³å‡ºã—
            sendTextToAI(message, aiMsg);
        }

        sendBtn.addEventListener('click', sendMessage);

        chatInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Focus input on window open
        setTimeout(() => chatInput.focus(), 100);
    }

    // Function to open AI chat from navigation button
    function openAIChat() {
        createAIChat();
    }

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã§ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚­ãƒ£ãƒ—ãƒãƒ£ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’ä¿å­˜
    let screenCaptureStream = null;
    let screenCaptureVideo = null;
    let isScreenCaptureActive = false;

    // ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚­ãƒ£ãƒ—ãƒãƒ£ä»˜ãã§AIãƒãƒ£ãƒƒãƒˆã‚’é–‹ãé–¢æ•°
    async function openAIWithScreenshot() {
        try {
            // ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚­ãƒ£ãƒ—ãƒãƒ£ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’å–å¾—ã—ã¦ä¿æŒ
            screenCaptureStream = await navigator.mediaDevices.getDisplayMedia({
                video: { mediaSource: 'screen' }
            });
            
            // ãƒ“ãƒ‡ã‚ªè¦ç´ ã‚’ä½œæˆã—ã¦ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’è¨­å®š
            screenCaptureVideo = document.createElement('video');
            screenCaptureVideo.srcObject = screenCaptureStream;
            screenCaptureVideo.play();
            
            // ã‚¹ãƒˆãƒªãƒ¼ãƒ ãŒçµ‚äº†ã—ãŸæ™‚ã®å‡¦ç†
            screenCaptureStream.getVideoTracks()[0].addEventListener('ended', () => {
                isScreenCaptureActive = false;
                screenCaptureStream = null;
                screenCaptureVideo = null;
            });
            
            screenCaptureVideo.addEventListener('loadedmetadata', () => {
                isScreenCaptureActive = true;
                
                // AIãƒãƒ£ãƒƒãƒˆã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’é–‹ã
                createAIChat();
                
                // ã‚­ãƒ£ãƒ—ãƒãƒ£æœ‰åŠ¹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                setTimeout(() => {
                    const chatMessages = document.getElementById('chat-messages');
                    if (chatMessages) {
                        const infoMsg = document.createElement('div');
                        Object.assign(infoMsg.style, {
                            background: '#dbeafe',
                            padding: '12px 16px',
                            borderRadius: '16px',
                            maxWidth: '85%',
                            alignSelf: 'center',
                            fontSize: '12px',
                            color: '#1e40af',
                            textAlign: 'center',
                            margin: '8px auto',
                            border: '1px solid #bfdbfe'
                        });
                        infoMsg.textContent = 'ğŸ“· ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚­ãƒ£ãƒ—ãƒãƒ£ãƒ¢ãƒ¼ãƒ‰æœ‰åŠ¹ã€‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡æ™‚ã«ç¾åœ¨ã®ç”»é¢ã‚‚é€ä¿¡ã•ã‚Œã¾ã™ã€‚';
                        chatMessages.appendChild(infoMsg);
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                    }
                }, 100);
            });
            
        } catch (error) {
            console.error('ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚­ãƒ£ãƒ—ãƒãƒ£ã‚¨ãƒ©ãƒ¼:', error);
            // ã‚¨ãƒ©ãƒ¼ã®å ´åˆã€é€šå¸¸ã®ãƒãƒ£ãƒƒãƒˆã‚’é–‹ã
            createAIChat();
            setTimeout(() => {
                const chatMessages = document.getElementById('chat-messages');
                if (chatMessages) {
                    const infoMsg = document.createElement('div');
                    Object.assign(infoMsg.style, {
                        background: '#f3f4f6',
                        padding: '12px 16px',
                        borderRadius: '16px',
                        maxWidth: '85%',
                        alignSelf: 'center',
                        fontSize: '12px',
                        color: '#6b7280',
                        textAlign: 'center',
                        margin: '8px auto'
                    });
                    infoMsg.textContent = 'ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚­ãƒ£ãƒ—ãƒãƒ£ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸã€‚é€šå¸¸ã®ãƒãƒ£ãƒƒãƒˆã‚’ãŠæ¥½ã—ã¿ãã ã•ã„ã€‚';
                    chatMessages.appendChild(infoMsg);
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }
            }, 100);
        }
    }

    // ç¾åœ¨ã®ç”»é¢ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£ã—ã¦Blobã¨ã—ã¦å–å¾—ã™ã‚‹é–¢æ•°
    function captureCurrentScreen() {
        return new Promise((resolve, reject) => {
            if (!isScreenCaptureActive || !screenCaptureVideo) {
                reject(new Error('ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚­ãƒ£ãƒ—ãƒãƒ£ãŒç„¡åŠ¹ã§ã™'));
                return;
            }
            
            const canvas = document.createElement('canvas');
            canvas.width = screenCaptureVideo.videoWidth;
            canvas.height = screenCaptureVideo.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(screenCaptureVideo, 0, 0);
            
            canvas.toBlob((blob) => {
                resolve(blob);
            }, 'image/png');
        });
    }

    // ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’AIã«é€ä¿¡ã™ã‚‹é–¢æ•°
    async function sendScreenshotToAI(imageBlob, prompt) {
        const chatMessages = document.getElementById('chat-messages');
        if (!chatMessages) return;

        // ç”»åƒã‚’Base64ã¨ã—ã¦ä¿å­˜ã™ã‚‹ãŸã‚ã®URL
        const imageUrl = URL.createObjectURL(imageBlob);
        
        // ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆç”»åƒä»˜ãï¼‰ã‚’ä¿å­˜
        chatHistory.push({
            type: 'user',
            content: prompt,
            image: imageUrl,
            timestamp: new Date()
        });

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºï¼ˆç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ä»˜ãï¼‰
        const userMsg = document.createElement('div');
        Object.assign(userMsg.style, {
            background: '#3b82f6',
            color: 'white',
            padding: '12px 16px',
            borderRadius: '16px 16px 4px 16px',
            maxWidth: '85%',
            alignSelf: 'flex-end',
            wordWrap: 'break-word',
            fontSize: '14px',
            lineHeight: '1.5',
            boxShadow: '0 1px 3px rgba(0,0,0,0.1)'
        });

        // ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ä½œæˆ
        const imagePreview = document.createElement('img');
        imagePreview.src = imageUrl;
        Object.assign(imagePreview.style, {
            maxWidth: '200px',
            maxHeight: '200px',
            borderRadius: '8px',
            marginBottom: '8px',
            display: 'block'
        });
        
        const textPart = document.createElement('div');
        textPart.textContent = prompt;
        
        userMsg.appendChild(imagePreview);
        userMsg.appendChild(textPart);
        chatMessages.appendChild(userMsg);
        chatMessages.scrollTop = chatMessages.scrollHeight;

        // AIãƒ¬ã‚¹ãƒãƒ³ã‚¹ç”¨ã®è¦ç´ ã‚’ä½œæˆ
        const aiMsg = document.createElement('div');
        Object.assign(aiMsg.style, {
            background: '#ffffff',
            padding: '12px 16px',
            borderRadius: '16px 16px 16px 4px',
            maxWidth: '85%',
            alignSelf: 'flex-start',
            wordWrap: 'break-word',
            fontSize: '14px',
            lineHeight: '1.5',
            border: '1px solid #e5e7eb',
            boxShadow: '0 1px 3px rgba(0,0,0,0.1)',
            color: '#374151'
        });
        aiMsg.textContent = 'ç”»é¢ã‚’åˆ†æä¸­...';
        chatMessages.appendChild(aiMsg);
        chatMessages.scrollTop = chatMessages.scrollHeight;

        let aiResponse = '';
        try {
            // FormDataã‚’ä½œæˆ
            const formData = new FormData();
            formData.append('image', imageBlob, 'screenshot.png');
            formData.append('prompt', prompt);

            // APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡
            const response = await fetch('/api/aireq', {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            // ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å‡¦ç†
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            aiMsg.textContent = '';

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                const chunk = decoder.decode(value, { stream: true });
                aiResponse += chunk;
                aiMsg.textContent += chunk;
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            // AIã®è¿”ç­”ã‚’ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã«ä¿å­˜
            if (aiResponse) {
                chatHistory.push({
                    type: 'ai',
                    content: aiResponse,
                    timestamp: new Date()
                });
            }

        } catch (error) {
            console.error('Screenshot AI API Error:', error);
            const errorMsg = 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã®è§£æãŒã§ãã¾ã›ã‚“ã§ã—ãŸã€‚';
            aiMsg.textContent = errorMsg;
            
            // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚‚ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã«ä¿å­˜
            chatHistory.push({
                type: 'ai',
                content: errorMsg,
                timestamp: new Date()
            });
        }
    }

    // ãƒ†ã‚­ã‚¹ãƒˆã®ã¿ã‚’AIã«é€ä¿¡ã™ã‚‹é–¢æ•°
    async function sendTextToAI(message, responseElement) {
        let aiResponse = '';
        try {
            // å‡¦ç†ä¸­è¡¨ç¤º
            responseElement.textContent = 'è€ƒãˆä¸­...';

            // APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡
            const response = await fetch('/api/text', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ message })
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            // ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å‡¦ç†
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            responseElement.textContent = '';

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                const chunk = decoder.decode(value, { stream: true });
                aiResponse += chunk;
                responseElement.textContent += chunk;
                
                // ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¨ãƒªã‚¢ã‚’ä¸‹ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
                const chatMessages = document.getElementById('chat-messages');
                if (chatMessages) {
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }
            }

            // AIã®è¿”ç­”ã‚’ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã«ä¿å­˜
            if (aiResponse) {
                chatHistory.push({
                    type: 'ai',
                    content: aiResponse,
                    timestamp: new Date()
                });
            }

        } catch (error) {
            console.error('AI API Error:', error);
            const errorMsg = 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚Gemini APIã‚­ãƒ¼ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
            responseElement.textContent = errorMsg;
            
            // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚‚ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã«ä¿å­˜
            chatHistory.push({
                type: 'ai',
                content: errorMsg,
                timestamp: new Date()
            });
        }
    }

    // ç”»åƒã‚’AIã«é€ä¿¡ã™ã‚‹é–¢æ•°
    async function sendImageToAI(imageFile, prompt) {
        const chatMessages = document.getElementById('chat-messages');
        if (!chatMessages) return;

        // ç”»åƒã‚’Base64ã¨ã—ã¦ä¿å­˜ã™ã‚‹ãŸã‚ã®URL
        const imageUrl = URL.createObjectURL(imageFile);
        
        // ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆç”»åƒä»˜ãï¼‰ã‚’ä¿å­˜
        chatHistory.push({
            type: 'user',
            content: prompt,
            image: imageUrl,
            timestamp: new Date()
        });

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºï¼ˆç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ä»˜ãï¼‰
        const userMsg = document.createElement('div');
        Object.assign(userMsg.style, {
            background: '#3b82f6',
            color: 'white',
            padding: '12px 16px',
            borderRadius: '16px 16px 4px 16px',
            maxWidth: '85%',
            alignSelf: 'flex-end',
            wordWrap: 'break-word',
            fontSize: '14px',
            lineHeight: '1.5',
            boxShadow: '0 1px 3px rgba(0,0,0,0.1)'
        });

        // ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ä½œæˆ
        const imagePreview = document.createElement('img');
        imagePreview.src = imageUrl;
        Object.assign(imagePreview.style, {
            maxWidth: '200px',
            maxHeight: '200px',
            borderRadius: '8px',
            marginBottom: '8px',
            display: 'block'
        });
        
        const textPart = document.createElement('div');
        textPart.textContent = prompt;
        
        userMsg.appendChild(imagePreview);
        userMsg.appendChild(textPart);
        chatMessages.appendChild(userMsg);
        chatMessages.scrollTop = chatMessages.scrollHeight;

        // AIãƒ¬ã‚¹ãƒãƒ³ã‚¹ç”¨ã®è¦ç´ ã‚’ä½œæˆ
        const aiMsg = document.createElement('div');
        Object.assign(aiMsg.style, {
            background: '#ffffff',
            padding: '12px 16px',
            borderRadius: '16px 16px 16px 4px',
            maxWidth: '85%',
            alignSelf: 'flex-start',
            wordWrap: 'break-word',
            fontSize: '14px',
            lineHeight: '1.5',
            border: '1px solid #e5e7eb',
            boxShadow: '0 1px 3px rgba(0,0,0,0.1)',
            color: '#374151'
        });
        aiMsg.textContent = 'åˆ†æä¸­...';
        chatMessages.appendChild(aiMsg);
        chatMessages.scrollTop = chatMessages.scrollHeight;

        let aiResponse = '';
        try {
            // FormDataã‚’ä½œæˆ
            const formData = new FormData();
            formData.append('image', imageFile);
            formData.append('prompt', prompt);

            // APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡
            const response = await fetch('/api/aireq', {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            // ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å‡¦ç†
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            aiMsg.textContent = '';

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                const chunk = decoder.decode(value, { stream: true });
                aiResponse += chunk;
                aiMsg.textContent += chunk;
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            // AIã®è¿”ç­”ã‚’ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã«ä¿å­˜
            if (aiResponse) {
                chatHistory.push({
                    type: 'ai',
                    content: aiResponse,
                    timestamp: new Date()
                });
            }

        } catch (error) {
            console.error('Image AI API Error:', error);
            const errorMsg = 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ç”»åƒã®è§£æãŒã§ãã¾ã›ã‚“ã§ã—ãŸã€‚';
            aiMsg.textContent = errorMsg;
            
            // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚‚ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã«ä¿å­˜
            chatHistory.push({
                type: 'ai',
                content: errorMsg,
                timestamp: new Date()
            });
        }
    }
  </script>
  <script src="assets/js/iframe-proxy.js"></script>
</body>

</html>
